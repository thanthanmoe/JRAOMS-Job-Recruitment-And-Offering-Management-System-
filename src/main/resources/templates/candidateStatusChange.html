<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>

	<div th:replace="side-bar :: head"></div>
    <link th:href="@{/assets/css/statuschange.css}" rel="stylesheet">

    <!-- Favicons -->
    <link rel="shortcut icon" type="icon/image" href="https://acedatasystems.com/wp-content/themes/acedata/shared/images/fav/favicon.ico">

    <div th:replace="side-bar :: head"></div>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

   
<script type="text/javascript" src="//code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/js/iziToast.min.js"></script>
  <script type="text/javascript" src="/assets/js/ckeditor.js"></script>
</head>

<body>
<div th:replace="side-bar :: header"></div>
<div th:replace="side-bar :: sidebar"></div>
<!-- ======= My arrows styles do not work because of this ======= -->
<div th:replace="side-bar :: popupCdn"></div>

<main id="main" class="main">
	<!-- Start #main -->
	<div class="container">

		<div>
			<div class="d-flex justify-content-center align-items-center" style="height: 50px;">

				<div class="noti-badge">
				    <span class="badge bg-primary badge-number candidate-badge  rounded-5" id="notInterviewCount">0</span>
					<button type="button" class="btn btn-arrow-right btn-custom-size changeActive modify text-light" style="border-color: deeppink;margin-right: 5px;" data-status="NOTINTERVIEW">
					NotInterview 
	                </button>
	            </div>
	            <div class="noti-badge">
	                <span class="badge bg-primary badge-number candidate-badge  rounded-5" id="cancelCount">0</span>
	                <button type="button" class="btn btn-arrow-right  btn-custom-size changeActive modify text-light" style="border-color: deeppink;margin-right: 5px;" data-status="CANCEL">Cancel</button>
	            </div>
	            <div class="noti-badge">
	                <span class="badge bg-primary badge-number candidate-badge  rounded-5" id="receiveCount">0</span>
	                <button type="button" class="btn btn-arrow-right btn-custom-size changeActive  modify text-light" th:classappend="${actionStage == 'RECEIVE'} ? 'active' : ''" style="border-color: deeppink;margin-right: 5px;" data-status="RECEIVE">Receive</button>
	            </div>
	            <div class="noti-badge">
	                <span class="badge bg-primary badge-number candidate-badge  rounded-5" id="viewCount">0</span>
	                <button type="button" class="btn btn-arrow-right btn-view-size changeActive modify text-light" style="border-color: deeppink;margin-right: 5px;" data-status="VIEW">View</button>
	            </div>
	            <div class="noti-badge">
	                <span class="badge bg-primary badge-number candidate-badge  rounded-5" id="consideringCount">0</span>
	                <button type="button" class="btn btn-arrow-right btn-custom-size changeActive modify text-light" style="border-color: deeppink;margin-right: 5px;" data-status="CONSIDERING">Considering</button>
	            </div>
	            <div class="noti-badge">
	                <span class="badge bg-primary badge-number candidate-badge  rounded-5" id="pendingCount">0</span>
	                <button type="button" class="btn btn-arrow-right btn-custom-size changeActive modify text-light" style="border-color: deeppink;margin-right: 5px;" data-status="PENDING">Pending</button>
	            </div>
	            <div class="noti-badge">
	                <span class="badge bg-primary badge-number candidate-badge  rounded-5" id="passedCount">0</span>
	                <button type="button" class="btn btn-arrow-right btn-custom-size changeActive modify text-light" th:classappend="${actionStage == 'PASSED'} ? 'active' : ''" style="border-color: deeppink;" data-status="PASSED">Pass</button>
	            </div>
			
            </div>
		</div>

	</div>
	<br>
	<div class="container">
		<div class="row">
			<div class="col-12" style="text-align: center;">
			
				<h5 style="font-size:20px;"> <b id="candidateCount" th:text="${candidateCount}"></b> candidates applied <b id="vacancyNameElement" th:text="${vacancyName}"></b> position</h5>
		
			</div>
		</div>
		
		<div class="row">
			<div class="col-8" style="text-align: center;"></div>
			<div class="col-4" style="text-align: right;">
                <input type="hidden" name="vacancyId" th:value="${vacancyId}">
                <input type="hidden" name="vacancyDepartment" th:value="${vacancyDepartment}">
                <input type="hidden" name="actionStage" th:value="${actionStage}">
				<a class="btn btn-success" onclick="xlsxForm()">
					<i class="fas fa-file-excel fa-lg excel-icon icon"></i>
				</a>
				<a class="btn btn-success"  onclick="pdfForm()">
					<i class="fas fa-file-pdf fa-lg pdf-icon icon"></i>
				</a>

				<button type="submit" class="btn btn-secondary" id="downloadButton">Download CV</button>
			</div>
		</div>
	</div>


	<div class="container">
	<section class="section">
   
			
			<!--modal box start-->
      <div class="modal fade"  id="nextStageModal"  tabindex="-1" role="dialog" aria-labelledby="nextStageModalLabel" aria-hidden="true" data-id="" data-stage="">
        <div class="modal-dialog modal-dialog-centered">    
          <div class="confirm modal-content">
            <h1>Confirm your action</h1>
            <p>
               Are you sure you want to proceed to change stage?
            </p>
            <form>
			      <button class="btn btn-danger" data-bs-dismiss="modal" aria-label="Close" id="nextStageCancel">Cancel</button>
			      <button type="button" class="btn btn-primary" onclick="stageForm()">Confirm</button>
			</form>
           
          </div>
        </div>
      </div>
      <!-- End Modal-->

      <!-- End Modal-->
		<h1></h1>

		<table id="example" class="display"  style="width: 100%;">

			<thead>

			<tr>
				<th scope="col">#</th>
				<th scope="col">Name</th>
				<th scope="col">Email</th>
				<th scope="col" id="technical">Technical</th>
				<th scope="col" id="experiences">Experiences</th>
				<th scope="col" id="downloadTh"><a id="checkButton" style="color: #045F5F;" onclick="toggleCheckboxes()">SelectAll</a><i class="bi bi-check-all fs-3"></i></th>
				<th scope="col" id="interviewStage">InterviewStage</th>
                <th scope="col" id="interviewDate">InterviewDate</th>
				<th scope="col" id="nextStage">ChangeStage</th>
				<th scope="col" id="comment">SendMail</th>
				<th scope="col" id="salary">Salary</th>
				<th scope="col" id="joinDate">JoinDate</th>
				<th scope="col">SeeMore</th>
			</tr>
			</thead>

			<tbody>

			</tbody>
			
			
			
		</table>
	
	</section>
	</div>
	<div class="modal fade" id="invite-mail" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content p-3">
                <div class="modal-header">
                    <h5 class="modal-title">Invitation Mail</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="to" class="form-label">To</label>
                            <input type="email" id="to" name="to" class="form-control" required readonly>
                            <input type="hidden" id="candidate_id" name="candidate_id">
                        </div>
                        <div class="mb-3">
                            <label for="cc" class="form-label">Cc</label>
                            <div class="input-group">
                                <input type="text" id="cc" name="cc" class="form-control" placeholder="Type and press Enter to add tags">
                            </div>
                            <div id="tagList" class="mt-2"></div>
                        </div>
                        <div class="mb-3">
                            <label for="subject" class="form-label">Subject</label>
                            <input type="text" id="subject" name="subject" class="form-control" required>
                        </div>
                        <fieldset class="mb-3">
                            <legend class="form-label">Interview type</legend>
                            <div class="form-check">
                                <input type="radio" id="online" name="interviewType" value="Online" class="form-check-input" checked>
                                <label for="online" class="form-check-label">Online</label>
                            </div>
                            <div class="form-check">
                                <input type="radio" id="in-person" name="interviewType" value="Inperson" class="form-check-input">
                                <label for="in-person" class="form-check-label">InPerson</label>
                            </div>
                        </fieldset>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="interview" class="form-label">Interview Stage</label>
                                <select id="interview" name="interviewStage" class="form-select">
                                    <option id="first" value="1st Interview" style="display: none">1st Interview</option>
                                    <option id="second" value="2nd Interview">2nd Interview</option>
                                    <option id="third" value="3rd Interview">3rd Interview</option>
                                    <option id="fourth" value="4th Interview">4th Interview</option>
                                    <option id="fifth" value="5th Interview">5th Interview</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="date" class="form-label">Date</label>
                                <input type="date" id="date" name="date" class="form-control" required>
                                <script>
                                    var today = new Date();
                                    var formattedMonth = ('0' + (today.getMonth() + 1)).slice(-2);
                                    var formattedDate = ('0' + today.getDate()).slice(-2);
                                    var minDate = today.getFullYear() + '-' + formattedMonth + '-' + formattedDate;
                                    document.getElementById('date').min = minDate;
                                </script>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="start-time" class="form-label">Start</label>
                                <input type="time" id="start-time" name="startTime" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label for="end-time" class="form-label">End</label>
                                <input type="time" id="end-time" name="endTime" class="form-control" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editor" class="form-label">Content</label>
                            <textarea id="editor" name="content" class="form-control"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="file" class="form-label">Attachment</label>
                            <input type="file" id="file" name="file" class="form-control">

                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary" id="invite-button">
                            <span id="invite-spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            Send
                        </button>
                    </div>
                </form>
            </div>
        </div>


        <!--Cc input-->
        <script>
            const ccInput = document.getElementById('cc');
            const tagList = document.getElementById('tagList');
            const addedEmails = new Set(); // Keep track of added emails

            ccInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault(); // Prevent the default Enter key behavior
                    const inputText = ccInput.value.trim();

                    // Split the input by various delimiters and validate each part as an email
                    const emails = inputText.split(/[,/;\s]+/).map(email => email.trim());

                    // Only add valid and unique emails
                    emails.forEach(email => {
                        if (isValidEmail(email) && email !== '' && !addedEmails.has(email)) {
                            const tag = document.createElement('span');
                            tag.className = 'badge bg-secondary me-2';
                            tag.innerHTML = email + ' <button type="button" class="btn-close btn-close-white"></button>';
                            tag.addEventListener('click', () => {
                                tagList.removeChild(tag);
                                addedEmails.delete(email);
                            });
                            tagList.appendChild(tag);
                            addedEmails.add(email);
                            // Output added email to console
                            console.log('Offer cc updated email:', email);
                        }
                    });

                    ccInput.value = '';
                }
            });

            function isValidEmail(email) {
                // A simple regex pattern to validate email format
                const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailPattern.test(email);
            }

        </script>


</div>
	
<!--Offer Modal -->
<div class="modal fade" id="offer-mail" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">

    <div class="modal-dialog modal-lg">
        <div class="modal-content p-3">
            <div class="modal-header">
                <h5 class="modal-title">Offer Mail</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="offer-form" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="to-offer" class="form-label">To</label>
                        <input type="email" id="to-offer" name="to" class="form-control" required readonly>
                        <input type="hidden" id="offer_candidate_id" name="offer_candidate_id">
                    </div>

                    <div class="mb-3">
                        <label for="cc-offer" class="form-label">Cc</label>
                        <div class="input-group">
                            <input type="text" id="cc-offer" name="cc-offer" class="form-control" placeholder="Type and press Enter to add tags">
                        </div>
                        <div id="tagList2" class="mt-2"></div>
                    </div>

                    <div class="mb-3">
                        <label for="subject-offer" class="form-label">Subject</label>
                        <input type="text" id="subject-offer" name="subject" class="form-control" required>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="date-offer" class="form-label">Join Date</label>
                            <input type="date" id="date-offer" name="joinDate" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label for="candidate_salary" class="form-label">Salary</label>
                            <input type="number" id="candidate_salary" name="salary" class="form-control" required>
                        </div>
                    </div>
                    <script>
                        var today = new Date();
                        var formattedMonth = ('0' + (today.getMonth() + 1)).slice(-2);
                        var formattedDate = ('0' + today.getDate()).slice(-2);
                        var minDate = today.getFullYear() + '-' + formattedMonth + '-' + formattedDate;
                        document.getElementById('date-offer').min = minDate;
                    </script>
                    <div class="mb-3">
                        <label for="editor-offer" class="form-label">Content</label>
                        <textarea id="editor-offer" name="content" class="form-control"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="file-offer" class="form-label">Attachment</label>
                        <input type="file" id="file-offer" name="file" class="form-control">
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary" id="offer-button">
                        <span id="offer-spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        Send
                    </button>
                </div>
            </form>
        </div>
    </div>


    <script>
        const ccOfferInput = document.getElementById('cc-offer');
        const tagList2 = document.getElementById('tagList2');
        const addedOfferEmails = new Set(); // Keep track of added emails

        ccOfferInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent the default Enter key behavior
                const inputText = ccOfferInput.value.trim();

                // Split the input by various delimiters and validate each part as an email
                const emails = inputText.split(/[,/;\s]+/).map(email => email.trim());

                // Only add valid and unique emails
                emails.forEach(email => {
                    if (isValidEmail(email) && email !== '' && !addedOfferEmails.has(email)) {
                        const tag = document.createElement('span');
                        tag.className = 'badge bg-secondary me-2';
                        tag.innerHTML = email + ' <button type="button" class="btn-close btn-close-white"></button>';
                        tag.addEventListener('click', () => {
                            tagList2.removeChild(tag);
                            addedOfferEmails.delete(email);
                        });
                        tagList2.appendChild(tag);
                        addedOfferEmails.add(email);
                        // Output added email to console
                        console.log('Offer cc updated email:', email);
                    }
                });

                ccOfferInput.value = '';
            }
        });

        function isValidEmail(email) {
            // A simple regex pattern to validate email format
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailPattern.test(email);
        }
    </script>

</div>
	
	<!-- End #main -->
</main>
		
<div th:replace="side-bar :: footer"></div>

<script>
    let table;
	$(document).ready(function () {
		//alert message
		iziToast.settings({
			timeout: 3000,
			resetOnHover: true,
			transitionIn: 'flipInX',
			transitionOut: 'flipOutX',
			position: 'topCenter',
			onOpen: function() {
				console.log('callback abriu!');
			},
			onClose: function() {
				console.log("callback fechou!");
			}
		});

		$('#nextStageCancel').click(function(event){ event.preventDefault(); return false;});
        
        $('#cancelNo').click(function(event){ event.preventDefault(); return false;});
        
		document.addEventListener("click", function (event) {
			// Check if the clicked element has the "btn" and "btn-arrow-right" classes
			if (
					event.target.classList.contains("btn") &&
					event.target.classList.contains("btn-arrow-right")
			) {
				// Remove the "active" class from all buttons
				const buttons = document.querySelectorAll(".btn.btn-arrow-right");
				buttons.forEach((btn) => btn.classList.remove("active"));

				// Add the "active" class to the clicked button
				event.target.classList.add("active");
			}
		});


        let vacancyIdInput = document.querySelector("input[name='vacancyId']");
        let actionStageInput = document.querySelector("input[name='actionStage']");
        let vacancyId = vacancyIdInput.value;
        let actionStage = actionStageInput.value;
        if(actionStage==="RECEIVE"){
            $('#salary').hide();
            $('#joinDate').hide();
            $('#interviewStage').hide();
            $('#interviewDate').hide();
            $('#comment').hide();
        }else{
            $('#downloadTh').hide();
        }
        table = $('#example').DataTable({

            "serverSide": true,
            "processing": true,
            "ajax": {
                "url":'/candidatePage/' + vacancyId + '/'+actionStage,
				"type": "GET",
				"error": function(xhr, textStatus, error) {
					// Log the error to console for debugging
					console.error("Ajax error:", textStatus, error);
				}

			},
			"columns": [
				{ name: "#", data: "id", targets: 0,className: "forId", },
				{ name: "Name", data: "name", targets: 1,className: "smallColumn", },
				{ name: "Email", data: "email", targets: 2, className: "smallColumn" },
				{ name: "Technical", data: "technical", targets: 3 },
				{
					data: "experiences",
					name: "Experiences",
					className: "experience",
					targets: 4,
					render: function(data, type, row) {
						return data + (data > 1 ? " years" : " year");
					}
				},
				{
					data: "id",
					targets: 5,
                    className: "select",
					render: function (data, type, row) {
						return '<td>' +
								'&nbsp;&nbsp;&nbsp;&nbsp;<input type="checkbox" name="check" value="' + row.id + '" style="width: 20px;height: 20px;">' +
								'</td>';
					},
					sortable: false
				},

				{
				    data: "interviewHistories",
                    name: "InterviewStage",
				    targets: 6,
				    className: "narrowColumn",
				    render: function (data, type, row) {

				        if (row.interviewHistories && row.interviewHistories.length > 0) {
                            let lastInterviewHistory = row.interviewHistories[row.interviewHistories.length - 1];
                               return lastInterviewHistory.action;
				        }
				        return '-';
				    },
				    sortable: false
				},
                {
                    data: "interviewHistories",
                    name: "InterviewDate",
                    targets: 7,

                    render: function (data, type, row) {

                        if (row.interviewHistories && row.interviewHistories.length > 0) {

                            var lastInterviewHistory = row.interviewHistories[row.interviewHistories.length - 1];

                            return lastInterviewHistory.date;
                        }
                        return '';
                    },

                    sortable: false
                },
				{
					data: "id",
					targets: 8, className: "narrowColumn",
					render: function (data, type, row) {
						let stage = row.cvStatus;
						let email=row.email;
						
						if (stage === "CANCEL") {
							return '<a  class="btn btn-primary btn-sm rounded-pill"  data-bs-toggle="modal" data-bs-target="#nextStageModal" onclick="nextStageModal(\'' + data + '\', \'' + stage + '\')">ReOffer</a>';
						}else if (stage === "RECEIVE") {
							return '<a  class="btn btn-primary btn-sm rounded-pill" data-bs-toggle="modal" data-bs-target="#nextStageModal" onclick="nextStageModal(\'' + data + '\', \'' + stage + '\')">View</a>';
						}
						else if (stage === "VIEW") {
							return '<a  class="btn btn-primary btn-sm rounded-pill" data-bs-toggle="modal" data-bs-target="#nextStageModal" onclick="nextStageModal(\'' + data + '\', \'' + stage + '\')">Considering</a>';
						} else if (stage === "CONSIDERING") {
							return '<a  class="btn btn-primary  btn-sm rounded-pill" data-bs-toggle="modal" data-bs-target="#nextStageModal" onclick="nextStageModal(\'' + data + '\', \'' + stage + '\')">Pending</a><br><br><a  class="btn btn-danger btn-sm rounded-pill" data-bs-toggle="modal" data-bs-target="#cancelModal" onclick="cancelModal(\'' + data + '\', \'' + stage + '\')">Cancel</a>';
						} else if (stage === "PENDING") {
							return '<a  class="btn btn-primary  btn-sm rounded-pill"  data-bs-toggle="modal"  data-bs-target="#nextStageModal" onclick="nextStageModal(\'' + data + '\', \'' + stage + '\')">Pass</a><br><br><a data-bs-toggle="modal" class="btn btn-danger btn-sm rounded-pill" data-bs-target="#cancelModal" onclick="cancelModal(\'' + data + '\', \'' + stage + '\')">Cancel</a>';
						} else {
							return '<a  class="btn btn-primary  btn-sm rounded-pill"  data-bs-toggle="modal" data-bs-target="#nextStageModal" onclick="nextStageModal(\'' + data + '\', \'' + stage + '\')">ReOffer</a> '; // Handle other cases if needed
						}

					},
					sortable: false,
				},
				{
					data: "id",
					targets: 9,
					render: function (data, type, row) {
						let stage = row.cvStatus;
						let email=row.email;
						let name=row.name;
                        let interviewHistory;
                        let lastInterviewHistory;

                        if (row.interviewHistories && row.interviewHistories.length > 0) {
                            lastInterviewHistory = row.interviewHistories[row.interviewHistories.length - 1];
                            interviewHistory = lastInterviewHistory.action;
                        }

						if(stage==="PENDING"){
						return '<button type="button" class="btn btn-primary btn-sm rounded-pill"  data-bs-toggle="modal" data-bs-target="#invite-mail" onclick="interviewInviteMailModal(\'' + data + '\', \'' + stage + '\', \'' + email + '\',\'' + name + '\',\'' + interviewHistory + '\')">SendMail</button>';
					}	
						else if(stage==="CONSIDERING"){
						return '<button type="button" class="btn btn-primary btn-sm rounded-pill" id="consideringMail"  data-bs-toggle="modal" data-bs-target="#invite-mail" onclick="inviteMailModal(\'' + data + '\', \'' + stage + '\', \'' + email + '\',\'' + name + '\',\'' + interviewHistory + '\')">SendMail</button>';
					}
						else{
						return '<button type="button" class="btn btn-primary btn-sm rounded-pill"  data-bs-toggle="modal" data-bs-target="#offer-mail" onclick="offerMailModal(\'' + data + '\', \'' + stage + '\', \'' + email + '\',\'' + name + '\')">OfferMail</button>';
					}
					},
					sortable: false,
				},
				{
				    name: "Salary",
				    data: "wages",
				    targets: 10,
				    render: function(data, type, row) {
				        if (data === null || data === undefined) {
				            return '-';
				        }
				        return data;
				    },
					sortable: true,
				},

				{
				    name: "JoinDate",
				    data: "joinDate",
				    targets: 11,
				    render: function(data, type, row) {
				        if (data === null || data === undefined) {
				            return '-';
				        }
				        return data;
				    },
					sortable: true,
				},

				{
					data: "id",
					targets: 12,
                    className: "experience",
					render: function (data, type, row) {
						return '&nbsp;<a href="/manage/seemorecandidate/' + row.id + '" style="text-decoration: none;">SeeMore<a>';
					},
					sortable: false
				},

				// ... other columns ...
			],
			"rowCallback": function (row, data) {
                let technicalTd = $(row).find('td:eq(3)');
                let experiencesTd=$(row).find('td:eq(4)');
				let showTd = $(row).find('td:eq(5)');
                let interviewTd=$(row).find('td:eq(6)');
                let interviewDate = $(row).find('td:eq(7)');
                let stage = $(row).find('td:eq(8)');
                let comment = $(row).find('td:eq(9)');
                let salaryTd = $(row).find('td:eq(10)');
                let joinDateTd=$(row).find('td:eq(11)');
                let status = data.cvStatus;


				if (status === "PENDING") {
					interviewTd.show();
					comment.show();
					showTd.hide();
					salaryTd.hide();
					joinDateTd.hide();
                    interviewDate.show();
					stage.hide();
					$('#comment').show();
					$('#nextStage').hide();
					$('#technical').hide();
					$('#salary').hide();
					$('#joinDate').hide();
					$('#experiences').hide();
					technicalTd.hide();
					experiencesTd.hide();
				}else if (status === "PASSED") {
					interviewTd.show();
					salaryTd.show();
					joinDateTd.show();
                    interviewDate.show();

					comment.show();
					showTd.hide();
                    stage.hide();
                    technicalTd.hide();
                    experiencesTd.hide();
					$('#nextStage').hide();
					$('#technical').hide();
					$('#experiences').hide();
                    $('#comment').show();

				}
				else if (status === "RECEIVE") {
					salaryTd.hide();
					joinDateTd.hide();
					showTd.show();
					interviewTd.hide();
					comment.hide();
                    interviewDate.hide();
					$('#salary').hide();
					$('#joinDate').hide();
					$('#nextStage').show();
					$('#comment').hide();
					$('#interviewStage').hide();
					$('#technical').show();
					$('#experiences').show();
					technicalTd.show();
					experiencesTd.show();
				}	else if (status === "CONSIDERING") {
                    interviewTd.show();
                    comment.show();
                    showTd.hide();
                    salaryTd.hide();
                    joinDateTd.hide();
                    interviewDate.show();
                    stage.hide();
                    $('#comment').show();
                    $('#nextStage').hide();
                    $('#technical').hide();
                    $('#salary').hide();
                    $('#joinDate').hide();
                    $('#experiences').hide();
                    technicalTd.hide();
                    experiencesTd.hide();
				}  else if(status === "NOTINTERVIEW"){
                    showTd.hide();
                    interviewTd.hide();
                    interviewDate.hide();
                    salaryTd.hide();
                    joinDateTd.hide();
                    comment.hide();
                    stage.hide();
                    $('#nextStage').hide();
                    $('#salary').hide();
                    $('#joinDate').hide();
                    $('#technical').show();
                    $('#experiences').show();
                    technicalTd.show();
                    experiencesTd.show();
                } else {
					showTd.hide();
					interviewTd.hide();
                    interviewDate.hide();
					salaryTd.hide();
					joinDateTd.hide();
					comment.hide();
					stage.show();
					$('#nextStage').show();
					$('#salary').hide();
					$('#joinDate').hide();
					$('#technical').show();
					$('#experiences').show();
					technicalTd.show();
					experiencesTd.show();
				}
			},

			targets: 6,
			createdRow: function (row, data) {
				var showTd = $(row).find('td:eq(7)');
				var status = data.cvStatus;

				if (status === "PASSED") {
					showTd.hide();

				} else {
					showTd.show();
				}
			},


		});



		// Function to update the count column
		function updateCountColumn() {
			var info = table.page.info();
			var currentPage = info.page;
			var recordsPerPage = info.length;
			var startCount = currentPage * recordsPerPage + 1;

			table.rows().every(function (rowIdx) {
				var currentCount = startCount + rowIdx;
				this.cell(rowIdx, 0).data(currentCount);
			});
		}

		// Initial count update
		updateCountColumn();

		// Button onclick event
		$('.changeActive').click(function () {

			var status = $(this).data('status');
			var url = '/candidatePage/' + vacancyId + '/' + status;
			table.ajax.url(url).load();

			if (status === "PASSED") {
				$('#downloadTh').hide();
				$('#nextStage').hide();
				$('#downloadButton').hide();
				$('#interviewStage').show();
                $('#interviewDate').show();
				$('#comment').show();
				$('#technical').hide();
				$('#experiences').hide();
				$('#salary').show();
				$('#joinDate').show();
			}
			else  if (status==="PENDING") {
				$('#downloadTh').hide();
				$('#nextStage').show();
				$('#downloadButton').hide();
				$('#interviewStage').show();
                $('#interviewDate').show();
				$('#comment').show();
				$('#technical').hide();
				$('#salary').hide();
				$('#joinDate').hide();
				$('#experiences').hide();

			} else if (status === "RECEIVE") {
				$('#salary').hide();
				$('#joinDate').hide();
				$('#downloadButton').show();
				$('#downloadTh').show();
				$('#technical').show();
				$('#nextStage').show();
				$('#experiences').show();
				$('#interviewStage').hide();
                $('#interviewDate').hide();
				$('#comment').hide();
			}else  if (status === "CONSIDERING") {
                $('#downloadTh').hide();
                $('#nextStage').show();
                $('#downloadButton').hide();
                $('#interviewStage').show();
                $('#interviewDate').show();
                $('#comment').show();
                $('#technical').hide();
                $('#salary').hide();
                $('#joinDate').hide();
                $('#experiences').hide();

			}
			else {
				$('#downloadButton').hide();
				$('#salary').hide();
				$('#joinDate').hide();
				$('#downloadTh').hide();
				$('#nextStage').show();
				$('#interviewStage').hide();
                $('#interviewDate').hide();
				$('#comment').hide();
			}

		});

		table.on('draw.dt', function () {
			updateCountColumn();
		});
	});


 $('#downloadButton').click(function(event) {
        event.preventDefault(); // Prevent the default behavior of the button

        iziToast.settings({
            function(instance, toast) {
                instance.hide({
                    transitionOut: 'fadeOutUp'
                })}
        });
        var selectedIds = [];
        $('input[name="check"]:checked').each(function() {
            selectedIds.push($(this).val());
        });

        // Validate if at least one checkbox is checked
        if (selectedIds.length === 0) {
            iziToast.warning({
                message: 'Please select at least one item to Download.',
                transitionOut: 'fadeOutUp'
            });
            return;
        }

        console.log("Selected IDs: ", selectedIds);

        // Download zipfile for CV
        let form = $('<form action="/senior/downloadAllCV" method="POST" style="display: none;"></form>');
        selectedIds.forEach(function(id) {
            form.append($('<input type="hidden" name="id" value="' + id + '">'));
        });

        // Directly submit the form
        $('body').append(form);

        form.submit();
        form.remove();
     refreshCandidatesData();
     setTimeout(() => {
         iziToast.success({ message: 'Successfully downloaded and changed this candidate to view.' });
         var vacancyIdInput = document.querySelector("input[name='vacancyId']");
         var vacancyId = vacancyIdInput.value;
         var newUrl = '/candidatePage/' + vacancyId + '/RECEIVE';
         var table = $('#example').DataTable();
         table.ajax.url(newUrl).load();
         refreshCandidatesData();
     }, 2000);
    });

    //Stage Change script
	function nextStageModal(data, stage) {
	    document.getElementById('nextStageModal').dataset.id = data;
	    document.getElementById('nextStageModal').dataset.stage = stage;
	}

	function stageForm() {
	    let stage = document.getElementById('nextStageModal').dataset.stage;
	    let rowId = document.getElementById('nextStageModal').dataset.id;
	    var vacancyIdInput = document.querySelector("input[name='vacancyId']");
		var vacancyId = vacancyIdInput.value;
	    var url;

	    if(stage === "RECEIVE"){
	        url = '/senior/actionChange/VIEW/' + rowId + '/' + vacancyId;
	    } else if(stage === "VIEW"){
	        url = '/senior/actionChange/CONSIDERING/' + rowId + '/' + vacancyId;
	    } else if(stage === "CONSIDERING"){
	        url = '/senior/actionChange/PENDING/' + rowId + '/' + vacancyId;
	    } else if(stage === "PENDING"){
	        url = '/senior/actionChange/PASSED/' + rowId + '/' + vacancyId;
	    } else if(stage === "CANCEL"){
	        url = '/senior/actionChange/CONSIDERING/' + rowId + '/' + vacancyId;
	    }

	    $.ajax({
	        url: url,
	        type: 'GET',
	        contentType: 'application/json',
	        success: function (data) {
                iziToast.success({message: 'Successfully Change this candidates.' });
	            var nextStageModal = document.getElementById('nextStageModal');
			    var modalInstance = bootstrap.Modal.getOrCreateInstance(nextStageModal);
			    modalInstance.hide();
			    var newUrl = '/candidatePage/' + vacancyId + '/'+stage;
		        var table = $('#example').DataTable();
		        table.ajax.url(newUrl).load();
                refreshCandidatesData();
	        },
	        error: function (request, status, error) {
	            console.log('Error: ', error);
	        }
	    });
	}

	// Function to toggle all checkboxes on button click
	var isChecked = false;

	function toggleCheckboxes() {
		var checkboxes = document.getElementsByName('check');
		isChecked = !isChecked;

		for (var i = 0; i < checkboxes.length; i++) {
			checkboxes[i].checked = isChecked;
		}

		var button = document.getElementById('checkButton');
		button.innerHTML = isChecked ? 'Unselect All' : 'Select All';
	}
	function pdfForm() {
		let format = "pdf";  // or "xlsx"
		var vacancyIdInput = document.querySelector("input[name='vacancyId']");
		var vacancyId = vacancyIdInput.value;

		// Construct the URL
		var url = '/senior/report/'+format+'/'+vacancyId;

        iziToast.settings({
            function(instance, toast) {
                instance.hide({
                    transitionOut: 'fadeOutUp'
                })}
        });
		// Make the fetch call
		fetch(url, {
		    method: 'GET',
		    headers: {
		        'Accept': 'application/pdf, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
		    }
		})
		.then(response => {
		    if (!response.ok) {
		        throw new Error('Network response was not ok');
		    }

		    // Extract filename from content-disposition header
		    const contentDisposition = response.headers.get('Content-Disposition');
		    let filename = contentDisposition.split('filename=')[1];

		    // If the report is a PDF, handle it this way
		    if (filename.endsWith('.pdf')) {
		        return response.blob().then(blob => ({ blob, filename }));
		    }
		    // If the report is an XLSX, handle it this way
		    else if (filename.endsWith('.xlsx')) {
		        return response.blob().then(blob => ({ blob, filename }));
		    }
		})
		.then(({ blob, filename }) => {
		    const url = window.URL.createObjectURL(blob);
		    const a = document.createElement('a');
		    a.style.display = 'none';
		    a.href = url;
		    a.download = filename;
		    document.body.appendChild(a);
		    a.click();
		    window.URL.revokeObjectURL(url);
		})
		.catch(error => {
            iziToast.error({message: 'This Vacancy is no candidates.' });
		    console.error('Fetch error:', error);
		});
	}

	function xlsxForm() {
		let format = "xlsx";
		var vacancyIdInput = document.querySelector("input[name='vacancyId']");
		var vacancyId = vacancyIdInput.value;

		// Construct the URL
		var url = '/senior/report/'+format+'/'+vacancyId;

        iziToast.settings({
            function(instance, toast) {
                instance.hide({
                    transitionOut: 'fadeOutUp'
                })}
        });
		// Make the fetch call
		fetch(url, {
		    method: 'GET',
		    headers: {
		        'Accept': 'application/pdf, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
		    }
		})
		.then(response => {
		    if (!response.ok) {
		        throw new Error('Network response was not ok');
		    }

		    // Extract filename from content-disposition header
		    const contentDisposition = response.headers.get('Content-Disposition');
		    let filename = contentDisposition.split('filename=')[1];

		    // If the report is a PDF, handle it this way
		    if (filename.endsWith('.pdf')) {
		        return response.blob().then(blob => ({ blob, filename }));
		    }
		    // If the report is an XLSX, handle it this way
		    else if (filename.endsWith('.xlsx')) {
		        return response.blob().then(blob => ({ blob, filename }));
		    }
		})
		.then(({ blob, filename }) => {
		    const url = window.URL.createObjectURL(blob);
		    const a = document.createElement('a');
		    a.style.display = 'none';
		    a.href = url;
		    a.download = filename;
		    document.body.appendChild(a);
		    a.click();
		    window.URL.revokeObjectURL(url);
		})
		.catch(error => {
            iziToast.error({message: 'This Vacancy is no candidates.' });
		    console.error('Fetch error:', error);
		});
	}

</script>
<script type="text/javascript" src="/assets/js/send-mail.js"></script>
<script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script src="/assets/js/jquery.dataTables.min.js" type="text/javascript"></script>
<script src="/assets/js/jquery.spring-friendly.js" type="text/javascript"></script>
<div th:replace="side-bar :: scripts"></div>
</body>
</html>